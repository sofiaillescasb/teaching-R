---
title: "Titanic Analysis"
author: "Sofia Illescas"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

# 1. Importing libraries

Cuando estas haciendo un reporte para tu analisis de datos, se puede poner include=FALSE para que no salga anda en el documento. Me estoy dando cuenta de que si estamos usando esto como cuaderno de notas podriamos usar echo=TRUE con warning=FALSE y message=FALSE

```{r libraries, echo=TRUE, warning=FALSE, message=FALSE}
library(here)
library(readxl)
library(patchwork)
library(tidyverse)
```

# 2. Importing data

```{r data_imports}

dbset <- read_excel(here("dataset/titanic_dataset.xlsx"))

# Y si tuvieramos mÃ¡s de un hoja de Excel?
# path <- here("dataset/titanic_dataset.xlsx")
# dbset_list <- lapply(excel_sheets(path), read_excel, path = path)

# Vamos a revisar los datos
# Las columnas deben ser las variables dependientes y las filas deben ser observaciones
head(dbset)


colnames(dbset)

```

# 3. Cleaning data

Funciones de tidyverse (el paquete concreto es **dplyr**)

```{r dplyr_examples}

# select se usa para seleccionar columnas por nombre
# : se usa para seleccionar un rango de columnas, 
dbset %>%
  select("PassengerId":"Pclass")

dbset %>%
  filter(Sex=="female")

dbset %>%
  mutate("Pclass")


# dbset_no_missing_p_ticket %>%
#     dplyr::group_by(Pclass,Sex) %>%
#     reframe(Mean= mean(Fare),
#             Median= median(Fare))

# summ_stat <- function(df) {
#   df %>%
#     group_by(Sex) %>%
#     select(where(is.numeric)) %>%
#     summarise(across(everything(),
#                      Mean= ~ mean(.x),
#                      Median= ~ median(.x),
#                      CI= ~ confint(.x)))
# }
# 
# summ_stat(dbset)

```

```{r data_types}

dbset <- dbset %>%
  mutate(across(c("PassengerId", "Survived", "Pclass", "Sex", "Embarked","Ticket"), as.factor)) %>%
  mutate(across(c("Age","Fare"), as.numeric))

```

```{r missing_values}

dbset_no_missing <- dbset %>%
  select(where(~mean(is.na(.x)) < 0.2))

dbset_no_missing <- dbset_no_missing %>%
  drop_na()
```

```{r mean_comparison}

dbset_no_missing_p_ticket <- dbset_no_missing %>%
  group_by(Ticket) %>%
  mutate(Fare=mean(Fare)/n()) %>%
  ungroup()

  
dbset_no_missing_p_ticket %>%
  group_by(Pclass) %>%
  reframe(Mean= mean(Fare),
          Median= median(Fare)) %>%
  ungroup()

dbset_no_missing_p_ticket %>%
  group_by(Pclass,Survived) %>%
  reframe(Mean= mean(Fare),
          Median= median(Fare)) %>%
  ungroup()


fare_anova <- aov(Fare ~ Pclass + Survived, dbset_no_missing_p_ticket)
tukey_fare <- TukeyHSD(fare_anova)
tukey_fare

fare_anova <- aov(Fare ~ Pclass + Sex + Age + Survived, dbset_no_missing_p_ticket)
fare_anova <- aov(Fare ~ Pclass + Sex * Age + Survived, dbset_no_missing_p_ticket)
summary(fare_anova)
coefs_fare <- coefficients(fare_anova)

```

```{r}

dbset_no_missing_p_ticket %>%
  t.test(Fare ~ Survived, data=.)

dbset_no_missing_p_ticket %>%
  t.test(Age ~ Survived, data=.)

dbset_no_missing_p_ticket %>%
  glm(Survived ~ Pclass, family = "binomial", data=.)

dbset_no_missing_p_ticket %>%
  glm(Survived ~ Sex, family = "binomial", data=.)

dbset_no_missing_p_ticket %>%
  glm(Survived ~ Age, family = "binomial", data=.)

dbset_no_missing_p_ticket %>%
  glm(Survived ~ Pclass + Age, family = "binomial", data=.)

dbset_no_missing_p_ticket %>%
  glm(Survived ~ Age*Sex, family = "binomial", data=.)

model6 <- dbset_no_missing_p_ticket %>%
  glm(Survived ~ Age*Sex + Pclass, family = "binomial", data=.)

summary(model6)
plot(model6)

model6$linear.predictors

dbset_no_missing_p_ticket %>%
  ggplot(aes(Age, Survived)) +
  geom_point(alpha = 0.2) +
  geom_smooth(method = "glm", 
              method.args = list(family = "binomial"),
              formula = Survived ~ Fare) +
  labs(
    title = "Logistic Regression Model", 
    x = "Fare",
    y = "Survived"
    )


```

```{r}

p1 <- dbset_no_missing %>%
  ggplot(aes(x=Age, fill=Sex, color=Sex)) +
  geom_density(aes(y=after_stat(count)),alpha=0.6) +
  facet_wrap(~ Pclass, scales = "free")

age_ranges <- pretty(dbset_no_missing$Age, n=20)


dbset_age_split <- dbset_no_missing %>%
  mutate(Age.Range = cut(Age, age_ranges, include.lowest = FALSE))


p2 <- dbset_age_split %>%
  group_by(Sex, Age.Range) %>% 
  reframe(Passengers = n()) %>%
  mutate(Passengers=if_else(Sex=="female",-Passengers,Passengers)) %>%
  ggplot(aes(x = Age.Range,
         y = Passengers,
         fill = Sex)) + 
  coord_flip() +
geom_bar(stat = "identity") +
   scale_y_continuous(
     breaks = seq(-100,100,10),
     limits = c(-100,100),
     labels = abs(seq(-100,100,10))) 

p1 + p2

p1 / p2 & plot_annotation(tag_level = "A")

p1 / p2 & plot_annotation(tag_level = "a")

p1 / p2 & plot_annotation(tag_level = "I")

p1 / p2 & plot_annotation(tag_level = "A") & plot_layout(heights = c(1,2))


# library(apyramid)
# 
# dbset_age_split$Age.Range <- as.factor(dbset_age_split$Age.Range)
# 
# age_pyramid(dbset_age_split, age_group = "Age.Range", split_by = "Sex", proportional = FALSE, stack_by = "Pclass")
```

```{r}
dbset_no_missing %>%
  ggplot(aes(x=Age, fill=Pclass, color=Pclass)) +
  geom_density(aes(y=after_stat(count)),alpha=0.6) 

table(dbset_no_missing$Pclass)/nrow(dbset_no_missing)*100

dbset_no_missing %>%
  ggplot(aes(Survived, fill=Pclass, color=Pclass)) +
  geom_bar(alpha=0.6, position = "fill") 

dbset_no_missing %>%
  ggplot(aes(Pclass, fill=Survived, color=Survived)) +
  geom_bar(alpha=0.6, position = "fill") 

dbset_no_missing %>%
  ggplot(aes(Sex, fill=Survived, color=Survived)) +
  geom_bar(alpha=0.6, position = "fill") 

dbset_no_missing_p_ticket <- dbset_no_missing %>%
  group_by(Ticket) %>%
  mutate(Per_ticket=n()) %>%
  mutate(Fare=Fare/Per_ticket) %>%
  ungroup()

```
